<?php
//////////////////////////////////// - CLASSCONNECT 4.0 : ROADMAP ECHO - ////////////////////////////////////
// This file contains ClassConnect's core functionality. Enjoy!
/////////////////////////////////////////////////////////////////////////////////////////////////////////////


/////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Non-user specific functions (login, sessions, etc)
/////////////////////////////////////////////////////////////////////////////////////////////////////////////

// login user via email/username and password
function userLogin($identity, $password) {
	$errors = array();	
	
	if ($identity != '') {
		$identity = escape($identity);
	} else {
		$errors[1] = 'No username was entered.';
	}
	
	if ($password != '') {
		$password = escape($password);
	} else {
		$errors[1] = 'No password was entered.';
	}
	if (empty($errors)) {
		$user = good_query_assoc("SELECT * FROM users LEFT JOIN school_users ON school_users.uid = users.id WHERE users.pass = SHA1('$password') AND (users.user_name = '$identity' OR users.e_mail = '$identity' OR school_users.email='$identity') LIMIT 1");
		return $user;
	} else {
		return false;
	}
} // end userLogin


// check if this unverified user has an outstanding unverified school link
function checkUnverified($uid) {
		$linked = good_query_table("SELECT * FROM school_users WHERE uid = '$uid'");
		if ($linked == false) { // if there is no record of linked schools
				return false; // not verified, no school associations
			} else { // if we have schools they are enrolled in
				return true;
			}
}


// get a user's information
function getUser($userid) {
	$row = good_query_assoc("SELECT * FROM users WHERE id = '$userid' LIMIT 1");
	return $row;
} // end getUser


// get a user's email addresses
function getUserEmails($userid) {
	$emails = array();
	$row = good_query_assoc("SELECT * FROM users WHERE id = '$userid' LIMIT 1");
	$emails[] = $row['e_mail'];
	$linkedEmails = good_query_table("SELECT * FROM school_users WHERE uid = '$userid'");
	foreach ($linkedEmails as $user) {
		if ($user['email'] != '') {
			$emails[] = $user['email'];
		}
	}
	
	return $emails;
} // end getUserEmails


// If login success, set session variables
function setSession($userid) {
	// retrieve user information
	$row = getUser($userid);
	// retrieve user's classes
	if ($row['level'] == 1) {
		$classes = getEnrolledClasses($row['id'], 2);
	} elseif ($row['level'] == 3) {
		$classes = getClasses($row['id'], 2);
	}
	
	$schools = getVerifiedSchools($userid);
	
	setNodeSession($userid, session_id());
	
	$_SESSION['session_key'] = $genSessID;
	
	// set session variables
	$_SESSION['user_id'] = $row['id'];
	$_SESSION['first_name'] = $row['first_name'];
	$_SESSION['last_name'] = $row['last_name'];
	$_SESSION['level'] = $row['level'];
	$_SESSION['classes'] = $classes;
	$_SESSION['schools'] = $schools;
	$_SESSION['status'] = $row['verified'];
	
	// load our theme
	$theme = getTheme();
	$_SESSION['theme'] = $theme;
} // end setSession


// set node session
function setNodeSession($userID, $sessID) {
	good_query("INSERT INTO users_keys (session_key, uid, start_time) VALUES ('$sessID', '$userID', NOW() )");	
}




// This function will get the user's theme
function getTheme() {
	$count = 1;
	foreach($_SESSION['schools'] as $school) {
			if ($count == 1) {
				$return = $school;
			}
			$count++;
	} // foreach loop
	
	
	return $school;
} // end checkClassOwner


// This function will detect is the user is logged in
function checkSession() {
	// detect if user_id session is set
	if (!isset($_SESSION['user_id'])) {
		// return null
		return false;
	} else {
		//return true
		return true;
	}
} // end checkSession


// check if they are logged in; if not, redirect
function requireSession($reqLev) {
	global $level;
	global $status;
	if (checkSession() == true) {
	// if this user is not verified, detect level
	if ($status == 1) {
			header('location:signup.cc');
	
	// if the user is verified, send them home
	} elseif ($status == 2) {
		if (is_numeric($reqLev)) {
			if ($level != $reqLev) {
				header('location:home.cc');
			}
		}
	}
	
	} else { // if there is a prev session detected
		header('location:login.cc');
	}

} // end requireSession


// This function will kill a user's session
function killSession() {
	// detect if user_id session is set
	if (isset($_SESSION['user_id'])) {
		$sessionKey = session_id();
		
		$_SESSION = array();
		session_destroy();
		setcookie ('PHPSESSID', '', time()-3600, '/', '', 0, 0);
		
		good_query("DELETE FROM users_keys WHERE session_key = '$sessionKey' LIMIT 1");	
		}
} // end killSession


// reverse html stripping (use for embed codes, etc
function reverse_htmlentities($mixed)
{
    $htmltable = get_html_translation_table(HTML_ENTITIES);
    foreach($htmltable as $key => $value)
    {
        $mixed = ereg_replace(addslashes($value),$key,$mixed);
    }
    return $mixed;
}
// end reverse html entities



/////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END non-user specific functions (login, etc)
/////////////////////////////////////////////////////////////////////////////////////////////////////////////
















/////////////////////////////////////////////////////////////////////////////////////////////////////////////
// User generic functions
/////////////////////////////////////////////////////////////////////////////////////////////////////////////

// Reset password function
function setPassword($userID, $password) {
	$enc_pass  = SHA1($password);
	good_query("UPDATE users SET pass = '$enc_pass' WHERE id = $userID");
}
// end resetPassword function


// Reset password function
function sendPasswordEmail($userID, $password) {
	$user = getUser($userID);
	$body = "Hello " . $user['first_name'] . ",\n
	Your ClassConnect password has been reset. You can now login using your email/username and new password listed below.\n\n
	
	Your new password: $password \n\n
	
	If you encounter any problems, feel free to reply to this email and we'll assist you in any way possible!\n\n
	
	Sincerely,\n
	The ClassConnect Support Team";
	$emails = getUserEmails($userID);
	
	foreach ($emails as $address) {
		//mail($address, 'ClassConnect Account Password Reset', $body, "From: support@classconnect.com");
	}

}
// end resetPassword function










// send notification function
function sendNotification($appID, $userIDs, $content) {
	
	$uidArray = explode(',', $userIDs);
	foreach ($uidArray as $userID) {
		if (is_numeric($userID)) {
			$cleanContent = escape($content);
			good_query("INSERT INTO notifications (user_id, appID, content, sent_at) VALUES ('$userID', '$appID', '$cleanContent', NOW() )");
			$sessions = getSessions($userID);
			foreach ($sessions as $session) {
				// send nodeJS notification
				$content = str_replace('"', '_dq_', $content);
				sendNodeification(1, $appID, $session['session_key'], $content);
			}
			
		}
	}
	
	
}
// end sendNotification function



// send notification to entire class
function sendClassNotification($classID, $data) {
	// get all students in this class
		$students = getClassStudents($classID, 1);
	
		// loop through students array
		foreach ($students as $student) {
			$userIDs = $userIDs . $student['id'] . ',';
		}
		// send notification
		sendNotification(1, $userIDs, $data);
	
	
}
// end



// get active sessions
function getSessions($userID) {
	$sessionArray = good_query_table("SELECT * FROM users_keys WHERE uid = '$userID'");
	return $sessionArray;
}
// end getSessions




// send nodeJS notification to channel
function sendNodeification($type, $appID, $channelID, $data) {
	global $nodeServer;
	// hit node server
	$nodeURL = $nodeServer . '?type=' . urlencode($type) . '&appID=' . urlencode($appID) . '&channel=' . urlencode($channelID) . '&data=' . urlencode($data);
	file_get_contents($nodeURL);
}
// end sendNodeification



// get number of unread notifications
function getNumNotifications($userID) {
	$totalUnread = good_query_table("SELECT * FROM notifications WHERE user_id = '$userID' AND viewed = '1'");
	return count($totalUnread);
}
// end num notifications



// get notifications
function getNotifications($userID, $limit) {
	$total= good_query_table("SELECT * FROM notifications WHERE user_id = '$userID' ORDER BY `sent_at` DESC LIMIT $limit");
	return $total;
}
// end num notifications




// get notifications
function clearNotifications($userID) {
	$total= good_query("UPDATE notifications SET viewed = '2' WHERE user_id = '$userID' AND viewed = '1'");
}
// end num notifications


/////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END user generic functions
/////////////////////////////////////////////////////////////////////////////////////////////////////////////
























/////////////////////////////////////////////////////////////////////////////////////////////////////////////
// STUDENT specific functions
/////////////////////////////////////////////////////////////////////////////////////////////////////////////

// This function will redirect the user if they are not a student
function checkStudent() {
	if ($level != 1) {
		return false;
	} else {
		return true;
	}
} // end checkStudent


// This function will retrieve the classes a student is enrolled in
function getEnrolledClasses($studentid, $type) {
	if ($type == 1) {
		// if type is in past
		$myClasses = good_query_table("SELECT classes.name, classes.id, classes.prof_icon, classes.sid, classes.reg_date, classes.end_date, classes.gp, classes.status, grading_periods.start, grading_periods.end FROM classes LEFT JOIN class_students ON classes.id = class_students.cid LEFT JOIN grading_periods ON classes.gp = grading_periods.id WHERE class_students.uid = $studentid AND ((grading_periods.end < '" . date('Y-m-d') . "') OR classes.status = 2) ORDER BY grading_periods.start ASC");
	} elseif ($type == 2) {
		// select current classes
		$myClasses = good_query_table("SELECT classes.name, classes.id, classes.prof_icon, classes.sid, classes.reg_date, classes.gp, classes.status, grading_periods.start, grading_periods.end FROM classes LEFT JOIN class_students ON classes.id = class_students.cid LEFT JOIN grading_periods ON classes.gp = grading_periods.id WHERE class_students.uid = $studentid AND classes.status = 1 AND ((grading_periods.start <= '" . date('Y-m-d') . "' AND grading_periods.end >= '" . date('Y-m-d') . "') OR classes.gp = 0) ORDER BY grading_periods.start ASC");
	} elseif ($type == 3) {
		//if type == future
		$myClasses = good_query_table("SELECT classes.name, classes.id, classes.prof_icon, classes.sid, classes.reg_date, classes.gp, classes.status, grading_periods.start, grading_periods.end FROM classes LEFT JOIN class_students ON classes.id = class_students.cid LEFT JOIN grading_periods ON classes.gp = grading_periods.id WHERE class_students.uid = $studentid AND classes.status = 1 AND (grading_periods.start > '" . date('Y-m-d') . "') ORDER BY grading_periods.start ASC");
	}
	return $myClasses;
} // end getEnrolledClasses


// This function will check if a student is enrolled in a class
function checkEnrollment($classid) {
	global $myClasses;
	$bool = false;
	foreach($myClasses as $class) {
		if ($class['id'] == $classid) {
			$bool = true;
		} // if
	} // foreach loop
	return $bool;
} // end checkEnrollment

/////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END student specific functions
/////////////////////////////////////////////////////////////////////////////////////////////////////////////












/////////////////////////////////////////////////////////////////////////////////////////////////////////////
// CLASS specific functions
/////////////////////////////////////////////////////////////////////////////////////////////////////////////

// This function will validate a class code
function checkCode($key) {
	$codeCheck = good_query_assoc("SELECT * FROM classes WHERE classKey = '$key'");
	return $codeCheck;
} // end checkCode


// enroll student in a class
function enrollStudent($uid, $cid) {
	// see if they are either enrolled or banned from this class
	$check = good_query_assoc("SELECT * FROM class_students WHERE uid = '$uid' AND cid = '$cid'");
	if ($check != false) {
		return false;
	}
	// insert into class
	$classes = good_query("INSERT INTO class_students (uid, cid, reg_date) VALUES ('$uid', '$cid', NOW() )");
	return true;

} // end enrollStudent


// delete student's enrollment
function deleteEnrollment($uid, $cid) {
	good_query("DELETE FROM class_students WHERE uid = '$uid' AND cid = '$cid' LIMIT 1");
	
}
// end delete enrollment

/////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END class specific functions
/////////////////////////////////////////////////////////////////////////////////////////////////////////////











/////////////////////////////////////////////////////////////////////////////////////////////////////////////
// TEACHER specific functions
/////////////////////////////////////////////////////////////////////////////////////////////////////////////

// This function will redirect the user if they are not a teacher
function checkTeacher() {
	if ($level != 3) {
		return false;
	} else {
		return true;
	}
} // end checkTeacher


// This function will retrieve the classes a teacher owns
function getClasses($teacherid, $type) {
	if ($type == 1) {
		// if type is in past
		$myClasses = good_query_table("SELECT classes.name, classes.id, classes.prof_icon, classes.sid, classes.reg_date, classes.end_date, classes.gp, classes.status, grading_periods.start, grading_periods.end FROM classes LEFT JOIN class_teachers ON classes.id = class_teachers.cid LEFT JOIN grading_periods ON classes.gp = grading_periods.id WHERE class_teachers.uid = $teacherid AND ((grading_periods.end < '" . date('Y-m-d') . "') OR classes.status = 2) ORDER BY grading_periods.start ASC");
	} elseif ($type == 2) {
		// select current classes
		$myClasses = good_query_table("SELECT classes.name, classes.id, classes.prof_icon, classes.sid, classes.reg_date, classes.gp, classes.status, grading_periods.start, grading_periods.end FROM classes LEFT JOIN class_teachers ON classes.id = class_teachers.cid LEFT JOIN grading_periods ON classes.gp = grading_periods.id WHERE class_teachers.uid = $teacherid AND classes.status = 1 AND ((grading_periods.start <= '" . date('Y-m-d') . "' AND grading_periods.end >= '" . date('Y-m-d') . "') OR classes.gp = 0) ORDER BY grading_periods.start ASC");
	} elseif ($type == 3) {
		//if type == future
		$myClasses = good_query_table("SELECT classes.name, classes.id, classes.prof_icon, classes.sid, classes.reg_date, classes.gp, classes.status, grading_periods.start, grading_periods.end FROM classes LEFT JOIN class_teachers ON classes.id = class_teachers.cid LEFT JOIN grading_periods ON classes.gp = grading_periods.id WHERE class_teachers.uid = $teacherid AND classes.status = 1 AND (grading_periods.start > '" . date('Y-m-d') . "') ORDER BY grading_periods.start ASC");
	}
	return $myClasses;
} // end getClasses


// This function will check if a teacher owns this class
function checkClassOwner($classid) {
	global $user_id;
	global $myClasses;
	$bool = false;
	foreach($myClasses as $class) {
		if ($class['id'] == $classid) {
			$bool = true;
		} // if
	} // foreach loop
	
	// if it's false, lets check for non-current classes
	if ($bool == false) {
		$test = good_query_assoc("SELECT * FROM class_teachers WHERE uid = '$user_id' AND cid = '$classid' LIMIT 1");
		if ($test == true) {
			$bool = true;
		}
	}
	
	return $bool;
} // end checkClassOwner

/////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END teacher specific functions
/////////////////////////////////////////////////////////////////////////////////////////////////////////////












/////////////////////////////////////////////////////////////////////////////////////////////////////////////
// SCHOOL specific functions
/////////////////////////////////////////////////////////////////////////////////////////////////////////////

// get an schools's information
function getSchool($schoolID) {
	$row = good_query_assoc("SELECT * FROM schools WHERE id = '$schoolID' LIMIT 1");
	return $row;
} // end getApp


// This function will retrieve the schools a user is enrolled in
function getSchools($userID, $type) {
	$mySchools = good_query_table("SELECT * FROM schools LEFT JOIN school_users ON schools.id = school_users.sid WHERE school_users.uid = $userID ORDER BY school_users.reg_date DESC");
	return $mySchools;
} // end getEnrolledClasses


// This function will retrieve the schools a verified user is enrolled in
function getVerifiedSchools($userID) {
	$mySchools = good_query_table("SELECT * FROM schools LEFT JOIN school_users ON schools.id = school_users.sid WHERE school_users.uid = $userID AND school_users.verified = 2 ORDER BY school_users.reg_date DESC");
	return $mySchools;
} // end getVerifiedSchools


// This function will check if a user is linked to a school
function checkSchoolLink($schoolID) {
	global $mySchools;
	global $user_id;
	$bool = false;
	foreach($mySchools as $school) {
		if ($school['id'] == $schoolID) {
			$bool = true;
		} // if
	} // foreach loop
	if ($bool == false) {
		$findSchool = good_query_assoc("SELECT * FROM school_users WHERE uid = $user_id AND sid = $schoolID LIMIT 1");
		if ($findSchool != false) {
			$bool = true;
		}
		
	}
	
	return $bool;
} // end checkSchoolLink


// This function will check if a user is the admin of a school
function checkSchoolAdmin($sid) {
	global $mySchools;
	$bool = true;
	foreach($mySchools as $school) {
		if ($school['id'] == $sid) {
			// if the school is in "free mode", all teachers are admins
			if ($school['subscription'] == 0) {
				if ($school['type'] == 3) {
					$bool = true;
				}
				
			} else {
				// if teacher level is 4
				if ($school['type'] == 4) {
					$bool = true;
				}
			}

		} // if
	} // foreach loop
	return $bool;
} // end checkSchoolLink


// This function creates grading periods
function createGP($sid, $name, $start, $end) {
	$errors = array();
	// check for first name
	if ($sid != '') {
		$sid = escape($sid);
	} else {
		$errors[] = 'No school ID given.';
	}
	
	// check for first name
	if ($name != '') {
		$name = escape($name);
	} else {
		$errors[] = 'No name was entered.';
	}
	
	// check for start
	if ($start != '' && strlen($start) > 1) {
		$start_date = escape($start);
	}
	
	// check for end
	if (isset($start_date)) {
		if ($end != '' && strlen($end) > 1) {
			if ($end > $start) {
				$end_date = escape($end);
			} else {
				$errors[] = 'End date must be after the start date.';
			}
		} else {
			$errors[] = 'No end date was entered.';
		}
		}
		
	if (empty($errors)) {
		
		if (!isset($end_date)) {
			$start_date = '01/01/2001';
			$end_date = '01/01/2013';
		}
		
		$start_date = date('Y-m-d', strtotime($start_date));
		$end_date = date('Y-m-d', strtotime($end_date));
		
		
		good_query("INSERT INTO grading_periods (name, start, end, sid, reg_date) VALUES ('$name', '$start_date', '$end_date', '$sid', NOW() )");
		return 1;
	} else {
		return $errors;
	}
	
}
// end createGP function


// This function creates grading periods
function updateGP($gpid, $sid, $name, $start, $end) {
	$errors = array();
	// check for first name
	if ($sid != '') {
		$sid = escape($sid);
	} else {
		$errors[] = 'No school ID given.';
	}
	
	// check for first name
	if ($name != '') {
		$name = escape($name);
	} else {
		$errors[] = 'No name was entered.';
	}
	
	// check for start
	if ($start != '' && strlen($start) > 1) {
		$start_date = escape($start);
	}
	
	// check for end
	if (isset($start_date)) {
		if ($end != '' && strlen($end) > 1) {
			if ($end > $start) {
				$end_date = escape($end);
			} else {
				$errors[] = 'End date must be after the start date.';
			}
		} else {
			$errors[] = 'No end date was entered.';
		}
		}
		
	if (empty($errors)) {
		
		if (!isset($end_date)) {
			$start_date = '01/01/2001';
			$end_date = '01/01/2013';
		}
		
		$start_date = date('Y-m-d', strtotime($start_date));
		$end_date = date('Y-m-d', strtotime($end_date));
		
		good_query("UPDATE grading_periods SET name='$name', start='$start_date', end='$end_date' WHERE sid = $sid AND id = $gpid");
		return 1;
	} else {
		return $errors;
	}
	
}
// end createGP function


// This function will retrieve the grading periods for a school
function getGPs($sid, $type) {
	if ($type == 1) {
		$append = "end < '" . date('Y-m-d') . "'";
	} elseif ($type == 2) {
		$append = "start <= '" . date('Y-m-d') . "' AND end >= '" . date('Y-m-d') . "'";
	} elseif ($type == 3) {
		$append = "start > '" . date('Y-m-d') . "'";
	}
	
	$gps = good_query_table("SELECT * FROM grading_periods WHERE sid = $sid AND $append ORDER BY `start` ASC");
	return $gps;
} // end getGps


// This function will retrieve a grading period
function getGP($gpid) {
	$gps = good_query_assoc("SELECT * FROM grading_periods WHERE id = $gpid LIMIT 1");
	return $gps;
} // end getGps


// this function makes our dates uniform
function formatGP($str) {
	$ret = date('m/d/Y', strtotime($str));
	return $ret;
}
//end formatGP


// create class function
function createClass($name, $body, $sid, $gp, $userID) {
	global $dbc;
	$errors = array();
	
	if (checkSchoolLink($sid) != true) {
		$errors[] = 'Not valid school.';
	}
	
	// check for first name
	if ($sid != '') {
		$sid = escape($sid);
	} else {
		$errors[] = 'No school was chosen.';
	}
	
	// check for first name
	if ($name != '') {
		$name = escape($name);
	} else {
		$errors[] = 'No class name was entered.';
	}
	
	$body = escape($body);
	
	// check for first name
	if ($gp != '') {
		$gp = escape($gp);
	} else {
		$gp = 0;
	}
		
	if (empty($errors)) {
		$chash = genChash($name, $sid);
		$insertClass = @mysqli_query($dbc, "INSERT INTO classes (name, description, classKey, sid, gp, reg_date) VALUES ('$name', '$body', '$chash', '$sid', '$gp',  NOW() )");
		if (is_numeric($userID)) {
			$cid = $dbc->insert_id;
			addClassTeacher($userID, $cid, 2);
		}
		return 1;
	} else {
		return $errors;
	}
}
// end add class function


// update class function
function updateClass($uid, $cid, $name, $body, $code, $icon) {
	$errors = array();
	// check for class name
	if ($name != '') {
		$name = escape($name);
	} else {
		$errors[] = 'No class name was entered.';
	}
	
	$body = escape($body);
	$code = escape($code);
	
	// if empty errors, insert into db
	if (empty($errors)) {
		good_query("UPDATE classes SET name = '$name', description = '$body', classKey='$code', prof_icon='$icon' WHERE id = $cid LIMIT 1");
		return 1;
	}
	
	return $errors;
	
}
// end updateClass


// generate clas hash function
function genChash($name, $sid) {
	$chash = substr(SHA1($name . date('m/d/Y/i/s') . $sid . rand(1, 9999)),0,10);
	return $chash;
}
// end genChash function


// end class function
function endClass($cid) {
	good_query("UPDATE classes SET status = '2', end_date = NOW() WHERE id = $cid");
}
// end endClass function


// restart  class function
function restartClass($cid) {
	good_query("UPDATE classes SET status = '1' WHERE id = $cid");
}
// restart class function


// getClass function
function getClass($cid) {
	$class = good_query_assoc("SELECT * FROM classes WHERE id = $cid LIMIT 1");
	return $class;
}
// end getClass function


// addClassTeacher function
function addClassTeacher($uid, $cid, $master) {
	if ($master != 2) {
		$master = 1;
	}
	good_query("INSERT INTO class_teachers (uid, cid, master, reg_date) VALUES ('$uid', '$cid', '$master',  NOW() )");
	
}
//end addClassTeacher function


// auth class function
function authClass($class_id) {
	global $level;
	// if they're a teacher
	if ($level == 3) {
		// verify this teacher owns this class
		if (checkClassOwner($class_id) == true) {
			return 3;
		} else {
			// no enrollment or ownership
			return false;
		}
	
	// if they're a student
	} elseif ($level == 1) {
		if (checkEnrollment($class_id) == true) {
			return 1;
		} else {
		// no enrollment or ownership
		return false;
	}
	
	
	}

}
// end auth class



// get students in class
function getClassStudents($classID, $status) {
	$list = good_query_table("SELECT * FROM class_students LEFT JOIN users ON users.id = class_students.uid WHERE cid = $classID AND status = $status");
	return $list;
}
// end getClassStudents


// get teachers in class
function getClassTeachers($classID) {
	$list = good_query_table("SELECT * FROM class_teachers LEFT JOIN users ON users.id = class_teachers.uid WHERE cid = $classID");
	return $list;
}
// end getClassTeachers


// authorize student
function authClassStudent($classID, $uid) {
	$list = good_query_assoc("SELECT * FROM class_students LEFT JOIN users ON users.id = class_students.uid WHERE cid = $classID AND uid = $uid LIMIT 1");
	return $list;
}
// end getClassStudents



/////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END application specific functions
/////////////////////////////////////////////////////////////////////////////////////////////////////////////












/////////////////////////////////////////////////////////////////////////////////////////////////////////////
// APPLICATION specific functions
/////////////////////////////////////////////////////////////////////////////////////////////////////////////

// get an application's information
function getApp($appID) {
	$row = good_query_assoc("SELECT * FROM applications WHERE id = '$appID' LIMIT 1");
	return $row;
} // end getApp






// authorize session
function authSession($sessionID) {
	$data = good_query_assoc("SELECT * FROM users_keys WHERE session_key = '$sessionID' LIMIT 1");
	return $data;
}
// end authSession





// check class relation via API
function authClassRelationship($userID, $classID) {
	// check if they're a teacher
	$test = good_query_assoc("SELECT * FROM class_teachers WHERE uid = '$userID' AND cid = '$classID' LIMIT 1");
	if ($test == true) {
		return 3;
	}
	
	// if they're a student
	$test2 = good_query_assoc("SELECT * FROM class_students WHERE uid = '$userID' AND cid = '$classID' LIMIT 1");
	if ($test2 == true) {
		return 1;
	}
	
	
	return false;
	
}


/////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END application specific functions
/////////////////////////////////////////////////////////////////////////////////////////////////////////////
?>